CREATE DATABASE QLBANHANG
GO 
USE QLBANHANG
GO 

CREATE TABLE HANGSX(
	MaHangSX NCHAR(10) NOT NULL PRIMARY KEY,
	TenHang NVARCHAR(20) NOT NULL,
	DiaChi NVARCHAR(20),
	SoDT NVARCHAR(20),
	Email NVARCHAR(30)
)
GO

CREATE TABLE SANPHAM(
	MaSP NCHAR(10)NOT NULL PRIMARY KEY,
	MaHangSX NCHAR(10) NOT NULL,
	TenSP NVARCHAR(20),
	SoLuong INT,
	MauSac NVARCHAR(20),
	GiaBan MONEY,
	DonViTinh NCHAR(10),
	MoTa NVARCHAR(MAX),
	CONSTRAINT fk_hsx_sanpham FOREIGN KEY(MaHangSX) REFERENCES HANGSX(MaHangSX),
)
GO

CREATE TABLE NHANVIEN(
	MaNV NCHAR(10) NOT NULL PRIMARY KEY,
	TenNV NVARCHAR(20) NOT NULL,
	GioiTinh NCHAR(10),
	DiaChi NVARCHAR(30),
	SoDT NVARCHAR(20),
	Email NVARCHAR(30),
	TenPhong NVARCHAR(30)
)
GO

CREATE TABLE PNHAP(
	SoHDN NCHAR(10) NOT NULL PRIMARY KEY,
	NgayNhap DATE,
	MaNV NCHAR(10) NOT NULL
	CONSTRAINT fk_NHANVIEN_pnhap FOREIGN KEY(MaNV) REFERENCES NHANVIEN(MaNV)
)
GO

CREATE TABLE NHAP(
	SoHDN NCHAR(10) NOT NULL,
	MaSP NCHAR(10) NOT NULL,
	SoLuongN INT,
	DonGiaN MONEY,
	CONSTRAINT pk_NHAP PRIMARY KEY(SoHDN,MaSP),
	CONSTRAINT fk_Pn_nhap FOREIGN KEY(SoHDN) REFERENCES PNHAP(SoHDN),
	CONSTRAINT fk_sph_nhap FOREIGN KEY(MaSP) REFERENCES SANPHAM(MaSP)
)
GO

CREATE TABLE PXUAT(
	SoHDX NCHAR(10) NOT NULL PRIMARY KEY,
	NgayXuat DATE,
	MaNV NCHAR(10) NOT NULL,
	CONSTRAINT fk_NHANVIEN_pxuat FOREIGN KEY(MaNV) REFERENCES NHANVIEN(MaNV)
)
GO

CREATE TABLE XUAT(
	SoHDX NCHAR(10) NOT NULL,
	MaSP NCHAR(10) NOT NULL,
	SoLuongX INT,
	CONSTRAINT pk_XUAT PRIMARY KEY(SoHDX,MaSP),
	CONSTRAINT fk_PX_xuat FOREIGN KEY(SoHDX) REFERENCES PXUAT(SoHDX),
	CONSTRAINT fk_sanpham_xuat FOREIGN KEY(MaSP) REFERENCES SANPHAM(MaSP)
)
GO


INSERT INTO HANGSX VALUES('H01', 'SamSung', 'Korea', '011-08271212', 'ss@gmail.com.kr')
INSERT INTO HANGSX VALUES('H02', 'OPPO', 'China', '086-082613122', 'opp0@gmail.com.cn')
INSERT INTO HANGSX VALUES('H03', 'Vsmart', N'Việt Nam', '084-01091997', 'vsmart@gmail.com.vn')

INSERT INTO SANPHAM VALUES('SP01', 'H02', 'F1 Plus', '100', N'Xám', '7000000', N'Chiếc', N'Hàng cận cao cấp')
INSERT INTO SANPHAM VALUES('SP02', 'H01', 'Galaxy Note 11', '50', N'Đỏ', '19000000', N'Chiếc', N'Hàng cao cấp')
INSERT INTO SANPHAM VALUES('SP03', 'H02', 'F3 lite', '200', N'Nâu', '3000000', N'Chiếc', N'Hàng phổ thông')
INSERT INTO SANPHAM VALUES('SP04', 'H03', 'Joy3', '200', N'Xám', '3500000', N'Chiếc', N'Hàng phổ thông')
INSERT INTO SANPHAM VALUES('SP05', 'H01', 'Galaxy V21', '500', N'Nâu', '8000000', N'Chiếc', N'Hàng cận cao cấp')

INSERT INTO NHANVIEN VALUES('NV01', N'Nguyễn Thị Thu', 'Nữ', N'Hà Nội', '0982626521', 'thu@gmail.com', N'Kế toán')
INSERT INTO NHANVIEN VALUES('NV02', N'Lê Văn Nam', 'Nam', N'Bắc Ninh', '0972525252 ', 'nam@gmail.com', N'Vật tư')
INSERT INTO NHANVIEN VALUES('NV03', N'Trần Hòa Bình', 'Nữ', N'Hà Nội', '0328388388 ', 'hb@gmail.com', N'Kế toán')

INSERT INTO PNHAP VALUES('N01', '02-05-2019', 'NV01')
INSERT INTO PNHAP VALUES('N02', '04-07-2020', 'NV02')
INSERT INTO PNHAP VALUES('N03', '05-17-2020', 'NV02')
INSERT INTO PNHAP VALUES('N04', '03-22-2020', 'NV03')
INSERT INTO PNHAP VALUES('N05', '07-07-2020', 'NV01')


INSERT INTO NHAP VALUES('N01', 'SP02', '10', '17000000')
INSERT INTO NHAP VALUES('N02', 'SP01', '30', '6000000')
INSERT INTO NHAP VALUES('N03', 'SP04', '20', '1200000')
INSERT INTO NHAP VALUES('N04', 'SP01', '10', '6200000')
INSERT INTO NHAP VALUES('N05', 'SP05', '20', '7000000')

INSERT INTO PXUAT VALUES('X01', '06-14-2020', 'NV02')
INSERT INTO PXUAT VALUES('X02', '03-05-2019', 'NV03')
INSERT INTO PXUAT VALUES('X03', '12-14-2020', 'NV01')
INSERT INTO PXUAT VALUES('X04', '06-02-2020', 'NV02')
INSERT INTO PXUAT VALUES('X05', '05-15-2020', 'NV01')

INSERT INTO XUAT VALUES('X01', 'SP03', '5')
INSERT INTO XUAT VALUES('X02', 'SP01', '3')
INSERT INTO XUAT VALUES('X03', 'SP02', '1')
INSERT INTO XUAT VALUES('X04', 'SP03', '2')
INSERT INTO XUAT VALUES('X05', 'SP05', '1')


SELECT* FROM HANGSX
SELECT* FROM SANPHAM
SELECT* FROM NHANVIEN
SELECT* FROM PNHAP
SELECT* FROM NHAP
SELECT* FROM PXUAT
SELECT* FROM XUAT


--Bài 1
--a. Đưa ra các thông tin về các hóa đơn mà hãng Samsung đã nhập trong năm 2020, gồm: 
--SoHDN, MaSP, TenSP, SoLuongN, DonGiaN, NgayNhap, TenNV, TenPhong.
SELECT PNHAP.SoHDN, SANPHAM.MaSP, TenSP, SoLuongN, DonGiaN, NgayNhap, TenNV, TenPhong
FROM PNHAP INNER JOIN NHAP ON PNHAP.SoHDN = NHAP.SoHDN
INNER JOIN SANPHAM ON NHAP.MaSP=SANPHAM.MaSP
INNER JOIN NHANVIEN ON NHANVIEN.MaNV = PNHAP.MaNV
INNER JOIN HANGSX ON HANGSX.MaHangSX=SANPHAM.MaHangSX
WHERE TenHang=N'Samsung' AND YEAR(NGAYNHAP)=2020

--b. Đưa ra Top 10 hóa đơn xuất có số lượng xuất nhiều nhất trong năm 2020, sắp xếp theo chiều giảm dần của SoLuongX. 
SELECT TOP 10 XUAT.SoHDX, NgayXuat, SoLuongX
FROM XUAT INNER JOIN PXUAT ON XUAT.SoHDX = PXUAT.SoHDX
WHERE YEAR(NgayXuat) = 2020
ORDER BY SoLuongX DESC

--c. Đưa ra thông tin 10 sản phẩm có giá bán cao nhất trong cữa hàng, theo chiều giảm dần giá bán.SELECT TOP 10 MaSP, TenSP, GiaBan
FROM SANPHAM
ORDER BY GiaBan DESC

--d. Đưa ra các thông tin sản phẩm có giá bán từ 100.000 đến 500.000 của hãng Samsung. 
SELECT MaSP, TenSP, SoLuong, MauSac, GiaBan, DonViTinh, MoTa
FROM SANPHAM INNER JOIN HANGSX ON SANPHAM.MaHangSX = HANGSX.MaHangSX
WHERE TenHang = 'Samsung' AND GiaBan BETWEEN 100.000 AND 500.000

--e. Tính tổng tiền đã nhập trong năm 2020 của hãng Samsung. 
SELECT SUM(SoLuongN*DonGiaN) AS N'Tổng tiền nhập'
FROM NHAP INNER JOIN SANPHAM ON NHAP.MaSP = SANPHAM.MaSP
			INNER JOIN HANGSX ON SANPHAM.MaHangSX = HANGSX.MaHangSX
			INNER JOIN PNHAP ON NHAP.SoHDN = PNHAP.SoHDN
WHERE YEAR(NgayNhap) = 2020 AND TenHang = 'Samsung'

--f. Thống kê tổng tiền đã xuất trong ngày 14/06/2020.
SELECT SUM(SoLuongX*GiaBan) AS N'Tổng tiền xuất'
FROM XUAT INNER JOIN SANPHAM ON XUAT.MaSP = SANPHAM.MaSP
			INNER JOIN PXUAT ON XUAT.SoHDX = PXUAT.SoHDX
WHERE NgayXuat = '06/14/2020'

--g. Đưa ra SoHDN, NgayNhap có tiền nhập phải trả cao nhất trong năm 2020.SELECT NHAP.SoHDN, NgayNhapFROM NHAP INNER JOIN PNHAP ON NHAP.SoHDN = PNHAP.SoHDNWHERE YEAR(NgayNhap)=2020 AND SoLuongN*DonGiaN = (SELECT MAX(SoLuongN*DonGiaN)													FROM NHAP INNER JOIN PNHAP ON NHAP.SoHDN = PNHAP.SoHDN													WHERE YEAR(NgayNhap) = 2020)
--Bài 2
--a. Hãy thống kê xem mỗi hãng sản xuất có bao nhiêu loại sản phẩm
SELECT HANGSX.MaHangSX, TenHang, COUNT(*) AS N'Số lượng sp'
FROM SANPHAM INNER JOIN HANGSX ON SANPHAM.MaHangSX = HANGSX.MaHangSX
GROUP BY HANGSX.MaHangSX, TenHang

--b. Hãy thống kê xem tổng tiền nhập của mỗi sản phẩm trong năm 2020
SELECT SANPHAM.MaSP, TenSP, SUM(SoLuongN * DonGiaN) AS N'Tổng tiền nhập'
FROM NHAP INNER JOIN SANPHAM ON NHAP.MaSP = SANPHAM.MaSP
		  INNER JOIN PNHAP ON PNHAP.SoHDN = NHAP.SoHDN
WHERE YEAR(NgayNhap) = 2020
GROUP BY SANPHAM.MaSP, TenSP

--c. Hãy thống kê các sản phẩm có tổng số lượng xuất năm 2020 là lớn hơn 10.000 sản phẩm của hãng Samsung
SELECT SANPHAM.MaSP, TenSP, SUM(SoLuongN * DonGiaN) AS N'Tổng xuất'
FROM XUAT 
INNER JOIN SANPHAM 
ON XUAT.MaSP = SANPHAM.MaSP
INNER JOIN HANGSX 
ON HANGSX.MaHangSX = SANPHAM.MaHangSX
INNER JOIN PXUAT 
ON XUAT.SoHDX = PXUAT.SoHDX
WHERE YEAR(NgayXuat)=2018 AND TenHang = 'Samsung'
GROUP BY SANPHAM.MaSP, TENSP
HAVING SUM(SoLuongX) >= 10000


--d. Thống kê số lượng nhân viên Nam của mỗi phòng ban
SELECT TenPhong, COUNT(*) AS 'SỐ LƯỢNG NV'
FROM NHANVIEN
WHERE GioiTinh=1
GROUP BY TenPhong

--e. Thống kê tổng số lượng nhập của mỗi hãng sản xuất trong năm 2018
SELECT HANGSX.MaHangSX, TenHang, SUM(SoLuongN) AS N'Tổng số lượng nhập'
FROM HANGSX 
INNER JOIN SANPHAM 
ON HANGSX.MaHangSX=SANPHAM.MaHangSX
INNER JOIN NHAP 
ON NHAP.MaSP=SANPHAM.MaSP
INNER JOIN PNHAP 
ON NHAP.SoHDN=PNHAP.SoHDN
WHERE YEAR(NgayNhap)=2020
GROUP BY HANGSX.MaHangSX, TenHang

--f. Hãy thống kê xem tổng lượng tiên xuất của mỗi nhân viên trong năm 2018 là bao nhiêu
SELECT NHANVIEN.MaNV, TenNV, SUM(SoLuongX*GiaBan) AS N'Tổng tiền xuất'
FROM NHANVIEN INNER JOIN PXUAT 
ON NHANVIEN.MaNV=PXUAT.MaNV
INNER JOIN XUAT
ON PXUAT.SoHDX=XUAT.SoHDX
INNER JOIN SANPHAM
ON SANPHAM.MaSP=XUAT.MaSP
WHERE YEAR(NgayXuat)=2022
GROUP BY NHANVIEN.MaNV, TenNV