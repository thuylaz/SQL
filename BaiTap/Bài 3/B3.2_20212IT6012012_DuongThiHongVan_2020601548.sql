CREATE DATABASE THUCTAPP2
GO

USE THUCTAPP2
GO

CREATE TABLE KHOA(
	MAKHOA CHAR(10) PRIMARY KEY,
	TENKHOA CHAR(30) NOT NULL,
	DIENTHOAI CHAR(10) NOT NULL
	)
GO
	
CREATE TABLE GIANGVIEN(
	MAGV INT PRIMARY KEY,
	HOTENGV CHAR(30) NOT NULL,
	LUONG DECIMAL (5,2) NOT NULL,
	MAKHOA CHAR(10) FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA) ON UPDATE CASCADE ON DELETE CASCADE
	)
GO
CREATE TABLE SINHVIEN(
	MASV INT PRIMARY KEY,
	HOTENSV CHAR(30) NOT NULL,
	MAKHOA CHAR(10) FOREIGN KEY(MAKHOA) REFERENCES KHOA(MAKHOA) ON UPDATE CASCADE ON DELETE CASCADE,
	NAMSINH INT,
	QUEQUAN CHAR(30)
	)
GO

CREATE TABLE DETAI(
	MADT CHAR(10) PRIMARY KEY,
	TENDT CHAR(30) NOT NULL,
	KINHPHI INT NOT NULL,
	NOITHUCTAP CHAR(30) NOT NULL
	)
GO

CREATE TABLE HUONGDAN(
	MASV INT PRIMARY KEY,
	MADT CHAR(10) FOREIGN KEY(MADT) REFERENCES(MADT) ON UPDATE CASCADE ON DELETE CASCADE,
	MAGV INT FOREIGN KEY(MAGV) REFERENCES(MAGV) ON UPDATE CASCADE ON DELETE CASCADE,
	KETQUA DECIMAL(5,2)
	)
GO

INSERT INTO KHOA VALUES
	('Geo', 'Dia li va QLTN', 3855413),
	('Math', 'Toan', 3855411),
	('Bio', 'Cong nghe Sinh hoc', 3855412);

INSERT INTO GIANGVIEN VALUES
	(11, 'Thanh Binh', 700, 'Geo'),
	(12, 'Thu Huong', 500,'Math'),
	(13, 'Chu Vinh',650,'Geo'),
	(14, 'Le Thi Ly',500, 'Bio'),
	(15, 'Tran Son', 900, 'Math');
INSERT INTO SINHVIEN VALUES
	('Dt01', 'GIS', 100, 'Nghe An'),
	('Dt02', 'ARC GIS', 500, 'Nam Dinh'),
	('Dt03', 'Spatial DB', 100, 'Ha Tinh'),
	('Dt04', 'MAP', 300, 'Quang Binh');

INSERT INTO HUONGDAN VALUES
	(1,'Dt01', 13, 8),
	(2,'Dt03', 14, 0),
	(3,'Dt03', 12, 10),
	(5,'Dt04', 14, 7),
	(6,'Dt01', 13, NULL),
	(7,'Dt04', 11, 10),
	(8,'Dt03', 15, 6);

SELECT DETAI.MADT,DETAI.TENDT
	FROM GIANGVIEN JOIN HUONGDAN
	ON GIANGVIEN.MAGV = HUONGDAN.MAGV JOIN DETAI
	ON DETAI.MADT = HUONGDAN.MADT
	WHERE GIANGVIEN.HOTENGV = 'Tran Son'

SELECT DETAI.MADT, DETAI.TENDT	
		FROM DETAI
		WHERE NOT EXISTS(
			SELECT HUONGDAN.MADT
			FROM HUONGDAN
			WHERE HUONGDAN.MADT = DETAI.MADT)

SELECT GIANGVIEN.MAGV, GIANGVIEN.HOTENGV, KHOA.TENKHOA
		FROM GIANGVIEN JOIN KHOA 
		ON GIANGVIEN.MAKHOA = KHOA.MAKHOA
		WHERE GIANGVIEN.MAGV IN(
			SELECT HUONGDAN.MAGV
			FROM HUONGDAN
			GROUP BY HUONGDAN.MAGV
			HAVING COUNT (HUONGDAN.MASV)>3)

SELECT DETAI.MaDT,DETAI.TENDT
		FROM DETAI
		WHERE DETAI.KINHPHI = (
			SELECT MAX(DETAI.KINHPHI)
		FROM DETAI)

SELECT DETAI.MADT,DETAI.TENDT
		FROM DETAI
		WHERE DETAI.MADT in (
			SELECT HUONGDAN.MADT
			FROM HUONGDAN
			GROUP BY HUONGDAN.MADT
			HAVING COUNT(HUONGDAN.MADT) > 2)

SELECT SINHVIEN.MASV,SINHVIEN.HOTENSV,HUONGDAN.KETQUA
FROM SINHVIEN JOIN HUONGDAN
ON SINHVIEN.MASV = HUONGDAN.MASV
JOIN KHOA
ON KHOA.MAKHOA = SINHVIEN.MAKHOA
WHERE KHOA.TENKHOA = 'Dia ly va QLTN'

SELECT KHOA.TENKHOA, COUNT(SINHVIEN.MASV) AS SOSV
		FROM SINHVIEN JOIN KHOA
		ON SINHVIEN.MAKHOA = KHOA.MAKHOA
		GROUP BY KHOA.TENKHOA

SELECT *
		FROM SINHVIEN JOIN HUONGDAN
		ON HUONGDAN.MASV = SINHVIEN.MASV JOIN DETAI
		ON DETAI.MADT = HUONGDAN.MADT
		WHERE SINHVIEN.QUEQUAN = DETAI.NOITHUCTAP

SELECT *
		FROM SINHVIEN JOIN HUONGDAN
		ON HUONGDAN.MASV = SINHVIEN.MASV
		WHERE HUONGDAN.KETQUA IS NULL

SELECT SINHVIEN.MASV,SINHVIEN.HOTENSV
		FROM SINHVIEN JOIN HUONGDAN
		ON HUONGDAN.MASV = SINHVIEN.MASV
		WHERE HUONGDAN.KETQUA = 0